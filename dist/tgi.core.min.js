(function(){"use strict";function t(e,r){var i;if(!1==this instanceof t)throw new Error("new operator required");if("string"==typeof e){var a=e;e={},e.name=a,"string"==typeof r&&(e.type=r)}e=e||{},this.name=e.name||null,this.label=e.label||e.name,this.label&&(this.label=this.label.charAt(0).toUpperCase()+this.label.slice(1)),this.type=e.type||"String",i=function(t){var e=t.split("(");return e[1]=parseInt(e[1]),e}(this.type),this.type=i[0],this.hint=e.hint||{},this.validationRule=e.validationRule||{};var s=[],o=["name","type","label","hint","value","validationRule"];switch(this.type){case"ID":s=getInvalidProperties(e,o),this.value=e.value||null;break;case"String":s=getInvalidProperties(e,o.concat(["placeHolder","quickPick","size"])),this.size=i[1]?i[1]:"number"==typeof e.size?e.size:e.size||50,this.value=e.value||null,e.quickPick&&(this.quickPick=e.quickPick),this.placeHolder=e.placeHolder||null;break;case"Date":s=getInvalidProperties(e,o.concat("placeHolder")),this.value=e.value||null,this.placeHolder=e.placeHolder||null;break;case"Boolean":s=getInvalidProperties(e,o),this.value=e.value===!1?!1:e.value||null;break;case"Number":s=getInvalidProperties(e,o.concat("placeHolder")),this.value=0===e.value?0:e.value||null,this.placeHolder=e.placeHolder||null;break;case"Model":s=getInvalidProperties(e,o),this.value=e.value||null,this.value instanceof t.ModelID&&(this.modelType=this.value.modelType);break;case"Group":s=getInvalidProperties(e,o),this.value=e.value||null;break;case"Table":s=getInvalidProperties(e,o.concat("group")),this.value=e.value||null,this.group=e.group||null;break;case"Object":s=getInvalidProperties(e,o),this.value=e.value||null}for(var n=this.getObjectStateErrors(),l=0;l<s.length;l++)n.push("invalid property: "+s[l]);if(n.length>1)throw new Error("error creating Attribute: multiple errors");if(n.length)throw new Error("error creating Attribute: "+n[0]);this._eventListeners=[],this._errorConditions={}}var e=this,r=function(){return{version:"0.0.7",Attribute:t,Model:i,injectMethods:function(e){e.Attribute=t,e.Model=i}}};t.ModelID=function(e){if(!1==this instanceof t.ModelID)throw new Error("new operator required");if(!1==e instanceof i)throw new Error("must be constructed with Model");this.value=e.get("id"),this.constructorFunction=e.constructor,this.modelType=e.modelType},t.ModelID.prototype.toString=function(){return"string"==typeof this.value?"ModelID("+this.modelType+":'"+this.value+"')":"ModelID("+this.modelType+":"+this.value+")"},t.prototype.toString=function(){return null===this.name?"new Attribute":"Attribute: "+this.name},t.prototype.onEvent=function(t,e){if(!(t instanceof Array)){if("string"!=typeof t)throw new Error("subscription string or array required");t=[t]}if("function"!=typeof e)throw new Error("callback is required");for(var r in t)if(t.hasOwnProperty(r)&&"*"!=t[r]&&!contains(["StateChange","Validate"],t[r]))throw new Error("Unknown command event: "+t[r]);return this._eventListeners.push({events:t,callback:e}),this},t.prototype._emitEvent=function(t){var e;for(e in this._eventListeners)if(this._eventListeners.hasOwnProperty(e)){var r=this._eventListeners[e];(r.events.length&&"*"===r.events[0]||contains(r.events,t))&&r.callback.call(this,t)}},t.prototype.coerce=function(t){var e,r=t;switch(this.type){case"String":return"undefined"==typeof r?"":"boolean"!=typeof r||r?r?(r=t.toString(),r.length>this.size?r.substring(0,this.size):r):"":"false";case"Number":return"undefined"==typeof r?0:r?("string"==typeof r?(r=r.replace(/^\s+|\s+$/g,""),e=r.split(" "),r=e.length?e[0]:"",r=Number(r.replace(/[^/0-9\ \.]+/g,""))):r=Number(r),r?r:0):0;case"Boolean":return"undefined"==typeof r?!1:"string"==typeof r?(r=r.toUpperCase(),"Y"===r||"YES"===r||"T"===r||"TRUE"===r||"1"===r?!0:!1):r?!0:!1;case"Date":return"string"==typeof r&&2==r.split("/").length&&(r=r+"/"+(new Date).getFullYear()),new Date(r)}throw Error("coerce cannot determine appropriate value")},t.prototype.getObjectStateErrors=function(){var e;switch(this.validationErrors=[],this.name||this.validationErrors.push("name required"),contains(["ID","String","Date","Boolean","Number","Model","Group","Table","Object"],this.type)||this.validationErrors.push("Invalid type: "+this.type),this.type){case"ID":break;case"String":"number"!=typeof this.size&&this.validationErrors.push("size must be a number from 1 to 255"),(this.size<1||this.size>255)&&this.validationErrors.push("size must be a number from 1 to 255"),null!==this.value&&"string"!=typeof this.value&&this.validationErrors.push("value must be null or a String");break;case"Date":null===this.value||this.value instanceof Date||this.validationErrors.push("value must be null or a Date");break;case"Boolean":null!==this.value&&"boolean"!=typeof this.value&&this.validationErrors.push("value must be null or a Boolean");break;case"Number":null!==this.value&&"number"!=typeof this.value&&this.validationErrors.push("value must be null or a Number");break;case"Model":this.value instanceof t.ModelID||this.validationErrors.push("value must be Attribute.ModelID");break;case"Group":if(null===this.value||this.value instanceof Array)for(e in this.value)this.value.hasOwnProperty(e)&&(this.value[e]instanceof t||this.validationErrors.push("each element in group must be instance of Attribute"),this.value[e].getObjectStateErrors().length&&this.validationErrors.push("group contains invalid members"));else this.validationErrors.push("value must be null or an array");break;case"Table":if(this.group instanceof t)if(this.group.value instanceof Array)if(this.group.value.length<1)this.validationErrors.push("group property value must contain at least one Attribute");else for(e in this.group.value)this.group.value.hasOwnProperty(e)&&(this.group.value[e]instanceof t||this.validationErrors.push("each element in group must be instance of Attribute"),this.group.value[e].getObjectStateErrors().length&&this.validationErrors.push("group contains invalid members"));else this.validationErrors.push("group.value must be an array");else this.validationErrors.push("group property required")}var r=getInvalidProperties(this.validationRule,["required","range","isOneOf","isValidModel"]);return r.length&&this.validationErrors.push("invalid validationRule: "+r),this.validationMessage=this.validationErrors.length>0?this.validationErrors[0]:"",this.validationErrors},t.prototype.validate=function(t){if("function"!=typeof t)throw new Error("callback is required");this.getObjectStateErrors(),this._emitEvent("Validate");var e;for(e in this._errorConditions)this._errorConditions.hasOwnProperty(e)&&this.validationErrors.push(this._errorConditions[e]);this.validationRule.required&&!this.value&&("Number"==this.type?0!==this.value&&this.validationErrors.push(this.label+" required"):"Boolean"==this.type?this.value!==!1&&this.validationErrors.push(this.label+" required"):this.validationErrors.push(this.label+" required")),this.validationRule.range&&(this.validationRule.range instanceof Array||(this.validationRule.range=[this.validationRule.range]),(this.validationRule.range[0]||0===this.validationRule.range[0])&&this.value<this.validationRule.range[0]&&this.validationErrors.push(this.label+" must be at least "+this.validationRule.range[0]),(this.validationRule.range[1]||0===this.validationRule.range[1])&&this.value>this.validationRule.range[1]&&this.validationErrors.push(this.label+" must be no more than "+this.validationRule.range[1])),this.validationRule.isOneOf&&(this.validationRule.isOneOf instanceof Array||(this.validationRule.isOneOf=[this.validationRule.isOneOf]),-1==this.validationRule.isOneOf.indexOf(this.value)&&this.validationErrors.push(this.label+" invalid")),this.validationMessage=this.validationErrors.length>0?this.validationErrors[0]:"",this._emitEvent("StateChange"),t.call(this)},t.prototype.setError=function(t,e){if(t=t||"",e=e||"",!t)throw new Error("condition required");if(!e)throw new Error("description required");this._errorConditions[t]=e},t.prototype.clearError=function(t){if(t=t||"",!t)throw new Error("condition required");delete this._errorConditions[t]},t.getAttributeTypes=function(){return["ID","String","Date","Boolean","Number","Model","Group","Table","Object"].slice(0)};var i=function(e){var r;if(!1==this instanceof i)throw new Error("new operator required");if(this.modelType="Model",this.attributes=[new t("id","ID")],e=e||{},e.attributes)for(r in e.attributes)e.attributes.hasOwnProperty(r)&&this.attributes.push(e.attributes[r]);var a=getInvalidProperties(e,["attributes"]),s=this.getObjectStateErrors();for(r=0;r<a.length;r++)s.push("invalid property: "+a[r]);if(s.length>1)throw new Error("error creating Model: multiple errors");if(s.length)throw new Error("error creating Model: "+s[0]);this._eventListeners=[],this._errorConditions={}};i.prototype.toString=function(){return"a "+this.modelType},i.prototype.copy=function(t){for(var e=0;e<this.attributes.length;e++)this.attributes[e].value=t.attributes[e].value},i.prototype.getObjectStateErrors=function(){if(this.validationErrors=[],this.attributes instanceof Array)if(this.attributes.length<1)this.validationErrors.push("attributes must not be empty");else for(var e=0;e<this.attributes.length;e++)0!==e||this.attributes[e]instanceof t&&"ID"==this.attributes[e].type||this.validationErrors.push("first attribute must be ID"),this.attributes[e]instanceof t||this.validationErrors.push("attribute must be Attribute");else this.validationErrors.push("attributes must be Array");return void 0===this.tags||this.tags instanceof Array||this.validationErrors.push("tags must be Array or null"),this.validationErrors},i.prototype.get=function(t){for(var e=0;e<this.attributes.length;e++)if(this.attributes[e].name.toUpperCase()==t.toUpperCase())return this.attributes[e].value},i.prototype.getAttributeType=function(t){for(var e=0;e<this.attributes.length;e++)if(this.attributes[e].name.toUpperCase()==t.toUpperCase())return this.attributes[e].type},i.prototype.set=function(t,e){for(var r=0;r<this.attributes.length;r++)if(this.attributes[r].name.toUpperCase()==t.toUpperCase())return void(this.attributes[r].value=e);throw new Error("attribute not valid for model")},i.prototype.validate=function(t){var e,r,i=this,a=0;if("function"!=typeof t)throw new Error("callback is required");i.getObjectStateErrors();for(r in i._errorConditions)i._errorConditions.hasOwnProperty(r)&&i.validationErrors.push(i._errorConditions[r]);if(i.validationErrors.length)return i.validationMessage=i.validationErrors.length>0?i.validationErrors[0]:"",i._emitEvent("StateChange"),void t.call(i);for(e=0;e<i.attributes.length;e++)a++,function(e){setTimeout(function(){e.validate(function(){e.validationErrors.length&&i.validationErrors.push("bush"),0===--a&&(i.validationErrors.length||i._emitEvent("Validate"),i.validationMessage=i.validationErrors.length>0?i.validationErrors[0]:"",i._emitEvent("StateChange"),t.call(i))})},0)}(i.attributes[e])},i.prototype.onEvent=function(t,e){if(!(t instanceof Array)){if("string"!=typeof t)throw new Error("subscription string or array required");t=[t]}if("function"!=typeof e)throw new Error("callback is required");for(var r in t)if(t.hasOwnProperty(r)&&"*"!=t[r]&&!contains(["StateChange","Validate"],t[r]))throw new Error("Unknown command event: "+t[r]);return this._eventListeners.push({events:t,callback:e}),this},i.prototype._emitEvent=function(t){var e;for(e in this._eventListeners)if(this._eventListeners.hasOwnProperty(e)){var r=this._eventListeners[e];(r.events.length&&"*"===r.events[0]||contains(r.events,t))&&r.callback.call(this,t)}},i.prototype.setError=function(t,e){if(t=t||"",e=e||"",!t)throw new Error("condition required");if(!e)throw new Error("description required");this._errorConditions[t]=e},i.prototype.clearError=function(t){if(t=t||"",!t)throw new Error("condition required");delete this._errorConditions[t]},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=r),exports.CORE=r):e.CORE=r}).call(this);