(function(){"use strict";function t(){}function e(){}function r(){}function i(){}function n(t,e){var r;if(!1==this instanceof n)throw new Error("new operator required");if("string"==typeof t){var i=t;t={},t.name=i,"string"==typeof e&&(t.type=e)}t=t||{},this.name=t.name||null,this.label=t.label||t.name,this.label&&(this.label=this.label.charAt(0).toUpperCase()+this.label.slice(1)),this.type=t.type||"String",r=function(t){var e=t.split("(");return e[1]=parseInt(e[1]),e}(this.type),this.type=r[0],this.hint=t.hint||{},this.validationRule=t.validationRule||{};var o=[],s=["name","type","label","hint","value","validationRule"];switch(this.type){case"ID":o=getInvalidProperties(t,s),this.value=t.value||null;break;case"String":o=getInvalidProperties(t,s.concat(["placeHolder","quickPick","size"])),this.size=r[1]?r[1]:"number"==typeof t.size?t.size:t.size||50,this.value=t.value||null,t.quickPick&&(this.quickPick=t.quickPick),this.placeHolder=t.placeHolder||null;break;case"Date":o=getInvalidProperties(t,s.concat("placeHolder")),this.value=t.value||null,this.placeHolder=t.placeHolder||null;break;case"Boolean":o=getInvalidProperties(t,s),this.value=t.value===!1?!1:t.value||null;break;case"Number":o=getInvalidProperties(t,s.concat("placeHolder")),this.value=0===t.value?0:t.value||null,this.placeHolder=t.placeHolder||null;break;case"Model":o=getInvalidProperties(t,s),this.value=t.value||null,this.value instanceof n.ModelID&&(this.modelType=this.value.modelType);break;case"Group":o=getInvalidProperties(t,s),this.value=t.value||null;break;case"Table":o=getInvalidProperties(t,s.concat("group")),this.value=t.value||null,this.group=t.group||null;break;case"Object":o=getInvalidProperties(t,s),this.value=t.value||null}for(var a=this.getObjectStateErrors(),u=0;u<o.length;u++)a.push("invalid property: "+o[u]);if(a.length>1)throw new Error("error creating Attribute: multiple errors");if(a.length)throw new Error("error creating Attribute: "+a[0]);this._eventListeners=[],this._errorConditions={}}function o(t){if(!1==this instanceof o)throw new Error("new operator required");if("function"==typeof t){var i=t;t={type:"Function",contents:i}}t=t||{};var n,s=getInvalidProperties(t,["name","description","type","contents","scope","timeout","theme","icon","bucket"]),a=[];for(n=0;n<s.length;n++)a.push("invalid property: "+s[n]);if(a.length>1)throw new Error("error creating Command: multiple errors");if(a.length)throw new Error("error creating Command: "+a[0]);for(n in t)this[n]=t[n];if(this.name=this.name||"(unnamed)","string"!=typeof this.name)throw new Error("name must be string");if("undefined"==typeof this.description&&(this.description=this.name+" Command"),"undefined"==typeof this.type&&(this.type="Stub"),!contains(["Stub","Menu","Presentation","Function","Procedure"],this.type))throw new Error("Invalid command type: "+this.type);switch(this.type){case"Stub":break;case"Menu":if(!(this.contents instanceof Array))throw new Error("contents must be array of menu items");if(!this.contents.length)throw new Error("contents must be array of menu items");for(n in this.contents)if(this.contents.hasOwnProperty(n)&&"string"!=typeof this.contents[n]&&!(this.contents[n]instanceof o))throw new Error("contents must be array of menu items");break;case"Presentation":if(!(this.contents instanceof e))throw new Error("contents must be a Presentation");break;case"Function":if("function"!=typeof this.contents)throw new Error("contents must be a Function");break;case"Procedure":if(!(this.contents instanceof r))throw new Error("contents must be a Procedure")}if("undefined"!=typeof this.scope&&!(this.scope instanceof c||this.scope instanceof l))throw new Error("optional scope property must be Model or List");if("undefined"!=typeof this.timeout&&"number"!=typeof this.timeout)throw new Error("timeout must be a Number");if("undefined"!=typeof this.timeout&&"number"!=typeof this.timeout)throw new Error("timeout must be a Number");if("undefined"!=typeof this.theme){if("string"!=typeof this.theme)throw new Error("invalid theme");if(!contains(["default","primary","success","info","warning","danger","link"],this.theme))throw new Error("invalid theme")}if("undefined"!=typeof this.icon){if("string"!=typeof this.icon)throw new Error("invalid icon");if(!contains(["fa","glyphicon"],this.icon.split("-")[0])||!this.icon.split("-")[1])throw new Error("invalid icon")}this._eventListeners=[]}function s(t){if(!1==this instanceof s)throw new Error("new operator required");if(!1==t instanceof n.ModelID)throw new Error("Attribute.ModelID required in constructor");this.dateCreated=new Date,this.modelID=t,this.attributeValues={}}function a(t){if(!1==this instanceof a)throw new Error("new operator required");t=t||{},t.name=t.name||"(unnamed)",t.description=t.description||"a Interface";var e,r=getInvalidProperties(t,["name","description"]),i=[];for(e=0;e<r.length;e++)i.push("invalid property: "+r[e]);if(i.length>1)throw new Error("error creating Procedure: multiple errors");if(i.length)throw new Error("error creating Procedure: "+i[0]);this.startCallback=null,this.stopCallback=null,this.mocks=[],this.mockPending=!1;for(e in t)this[e]=t[e]}var u=this,h=function(){return{version:"0.0.7",Application:t,Attribute:n,Command:o,Delta:s,Interface:a,Model:c,Presentation:e,Procedure:r,Request:i,injectMethods:function(u){u.Application=t,u.Attribute=n,u.Command=o,u.Delta=s,u.Interface=a,u.Model=c,u.Presentation=e,u.Procedure=r,u.Request=i}}};n.ModelID=function(t){if(!1==this instanceof n.ModelID)throw new Error("new operator required");if(!1==t instanceof c)throw new Error("must be constructed with Model");this.value=t.get("id"),this.constructorFunction=t.constructor,this.modelType=t.modelType},n.ModelID.prototype.toString=function(){return"string"==typeof this.value?"ModelID("+this.modelType+":'"+this.value+"')":"ModelID("+this.modelType+":"+this.value+")"},n.prototype.toString=function(){return null===this.name?"new Attribute":"Attribute: "+this.name},n.prototype.onEvent=function(t,e){if(!(t instanceof Array)){if("string"!=typeof t)throw new Error("subscription string or array required");t=[t]}if("function"!=typeof e)throw new Error("callback is required");for(var r in t)if(t.hasOwnProperty(r)&&"*"!=t[r]&&!contains(["StateChange","Validate"],t[r]))throw new Error("Unknown command event: "+t[r]);return this._eventListeners.push({events:t,callback:e}),this},n.prototype._emitEvent=function(t){var e;for(e in this._eventListeners)if(this._eventListeners.hasOwnProperty(e)){var r=this._eventListeners[e];(r.events.length&&"*"===r.events[0]||contains(r.events,t))&&r.callback.call(this,t)}},n.prototype.coerce=function(t){var e,r=t;switch(this.type){case"String":return"undefined"==typeof r?"":"boolean"!=typeof r||r?r?(r=t.toString(),r.length>this.size?r.substring(0,this.size):r):"":"false";case"Number":return"undefined"==typeof r?0:r?("string"==typeof r?(r=r.replace(/^\s+|\s+$/g,""),e=r.split(" "),r=e.length?e[0]:"",r=Number(r.replace(/[^/0-9\ \.]+/g,""))):r=Number(r),r?r:0):0;case"Boolean":return"undefined"==typeof r?!1:"string"==typeof r?(r=r.toUpperCase(),"Y"===r||"YES"===r||"T"===r||"TRUE"===r||"1"===r?!0:!1):r?!0:!1;case"Date":return"string"==typeof r&&2==r.split("/").length&&(r=r+"/"+(new Date).getFullYear()),new Date(r)}throw Error("coerce cannot determine appropriate value")},n.prototype.getObjectStateErrors=function(){var t;switch(this.validationErrors=[],this.name||this.validationErrors.push("name required"),contains(["ID","String","Date","Boolean","Number","Model","Group","Table","Object"],this.type)||this.validationErrors.push("Invalid type: "+this.type),this.type){case"ID":break;case"String":"number"!=typeof this.size&&this.validationErrors.push("size must be a number from 1 to 255"),(this.size<1||this.size>255)&&this.validationErrors.push("size must be a number from 1 to 255"),null!==this.value&&"string"!=typeof this.value&&this.validationErrors.push("value must be null or a String");break;case"Date":null===this.value||this.value instanceof Date||this.validationErrors.push("value must be null or a Date");break;case"Boolean":null!==this.value&&"boolean"!=typeof this.value&&this.validationErrors.push("value must be null or a Boolean");break;case"Number":null!==this.value&&"number"!=typeof this.value&&this.validationErrors.push("value must be null or a Number");break;case"Model":this.value instanceof n.ModelID||this.validationErrors.push("value must be Attribute.ModelID");break;case"Group":if(null===this.value||this.value instanceof Array)for(t in this.value)this.value.hasOwnProperty(t)&&(this.value[t]instanceof n||this.validationErrors.push("each element in group must be instance of Attribute"),this.value[t].getObjectStateErrors().length&&this.validationErrors.push("group contains invalid members"));else this.validationErrors.push("value must be null or an array");break;case"Table":if(this.group instanceof n)if(this.group.value instanceof Array)if(this.group.value.length<1)this.validationErrors.push("group property value must contain at least one Attribute");else for(t in this.group.value)this.group.value.hasOwnProperty(t)&&(this.group.value[t]instanceof n||this.validationErrors.push("each element in group must be instance of Attribute"),this.group.value[t].getObjectStateErrors().length&&this.validationErrors.push("group contains invalid members"));else this.validationErrors.push("group.value must be an array");else this.validationErrors.push("group property required")}var e=getInvalidProperties(this.validationRule,["required","range","isOneOf","isValidModel"]);return e.length&&this.validationErrors.push("invalid validationRule: "+e),this.validationMessage=this.validationErrors.length>0?this.validationErrors[0]:"",this.validationErrors},n.prototype.validate=function(t){if("function"!=typeof t)throw new Error("callback is required");this.getObjectStateErrors(),this._emitEvent("Validate");var e;for(e in this._errorConditions)this._errorConditions.hasOwnProperty(e)&&this.validationErrors.push(this._errorConditions[e]);this.validationRule.required&&!this.value&&("Number"==this.type?0!==this.value&&this.validationErrors.push(this.label+" required"):"Boolean"==this.type?this.value!==!1&&this.validationErrors.push(this.label+" required"):this.validationErrors.push(this.label+" required")),this.validationRule.range&&(this.validationRule.range instanceof Array||(this.validationRule.range=[this.validationRule.range]),(this.validationRule.range[0]||0===this.validationRule.range[0])&&this.value<this.validationRule.range[0]&&this.validationErrors.push(this.label+" must be at least "+this.validationRule.range[0]),(this.validationRule.range[1]||0===this.validationRule.range[1])&&this.value>this.validationRule.range[1]&&this.validationErrors.push(this.label+" must be no more than "+this.validationRule.range[1])),this.validationRule.isOneOf&&(this.validationRule.isOneOf instanceof Array||(this.validationRule.isOneOf=[this.validationRule.isOneOf]),-1==this.validationRule.isOneOf.indexOf(this.value)&&this.validationErrors.push(this.label+" invalid")),this.validationMessage=this.validationErrors.length>0?this.validationErrors[0]:"",this._emitEvent("StateChange"),t.call(this)},n.prototype.setError=function(t,e){if(t=t||"",e=e||"",!t)throw new Error("condition required");if(!e)throw new Error("description required");this._errorConditions[t]=e},n.prototype.clearError=function(t){if(t=t||"",!t)throw new Error("condition required");delete this._errorConditions[t]},n.getAttributeTypes=function(){return["ID","String","Date","Boolean","Number","Model","Group","Table","Object"].slice(0)},o.prototype.toString=function(){return this.type+" Command: "+this.name},o.prototype.onEvent=function(t,e){if(!(t instanceof Array)){if("string"!=typeof t)throw new Error("subscription string or array required");t=[t]}if("function"!=typeof e)throw new Error("callback is required");for(var r in t)if(t.hasOwnProperty(r)&&"*"!=t[r]&&!contains(["BeforeExecute","AfterExecute","Error","Aborted","Completed"],t[r]))throw new Error("Unknown command event: "+t[r]);this._eventListeners.push({events:t,callback:e})},o.prototype._emitEvent=function(t){var e;for(e in this._eventListeners)if(this._eventListeners.hasOwnProperty(e)){var r=this._eventListeners[e];(r.events.length&&"*"===r.events[0]||contains(r.events,t))&&r.callback.call(this,t)}"Completed"==t&&(this._eventListeners=[])},o.prototype.execute=function(){function t(){try{s.contents.apply(s,a)}catch(t){s.error=t,s._emitEvent("Error"),s._emitEvent("Completed"),s.status=-1}}function r(){s.status=0;for(var t=s.contents.tasks||[],e=0;e<t.length;e++){if("function"==typeof t[e]){var r=t[e];t[e]={requires:[-1],command:new o({type:"Function",contents:r})}}t[e].command._parentProcedure||(t[e].command._taskIndex=e,t[e].command._parentProcedure=s,t[e].command.onEvent("*",i));var n=!0;if("undefined"==typeof t[e].command.status){for(var a in t[e].requires){if("string"==typeof t[e].requires[a])for(var u=0;u<t.length;u++)t[u].label==t[e].requires[a]&&(!t[u].command.status||t[u].command.status<=0)&&(n=!1);if("number"==typeof t[e].requires[a])if(-1==t[e].requires[a])"0"!=e&&(!t[e-1].command.status||t[e-1].command.status<=0)&&(n=!1);else{var h=t[e].requires[a];(!t[h].command.status||t[h].command.status<=0)&&(n=!1)}}n&&t[e].command.execute()}}}function i(t){var e=s.contents.tasks,i=!0;switch(t){case"Error":s._emitEvent("Error");break;case"Completed":for(var n in e)e.hasOwnProperty(n)&&(e[n].command.status&&0!==e[n].command.status||(i=!1));i?s.complete():r()}}if(!this.type)throw new Error("command not implemented");if(!contains(["Function","Procedure","Presentation"],this.type))throw new Error("command type "+this.type+" not implemented");var n;switch(this.type){case"Presentation":if(!(this.contents instanceof e))throw new Error("contents must be a Presentation");if(n=this.contents.getObjectStateErrors(),n.length)throw new Error(n.length>1?"error executing Presentation: multiple errors":"error executing Presentation: "+n[0])}var s=this,a=arguments;this._emitEvent("BeforeExecute");try{switch(this.type){case"Function":this.status=0,setTimeout(t,0);break;case"Procedure":setTimeout(r,0)}}catch(u){this.error=u,this._emitEvent("Error"),this._emitEvent("Completed"),this.status=-1}this._emitEvent("AfterExecute")},o.prototype.abort=function(){this._emitEvent("Aborted"),this.status=-1,this._emitEvent("Completed")},o.prototype.complete=function(){this.status=1,this._emitEvent("Completed")},a.prototype.toString=function(){return this.description},a.prototype.canMock=function(){return!1},a.prototype.doMock=function(){if(this.mockPending=!1,!(this.mocks.length<1)){var t=this.mocks.shift();this.dispatch(t),this.mockPending=!0;var e=this;setTimeout(function(){e.doMock()},0)}},a.prototype.mockRequest=function(t){if(!(t instanceof Array||t instanceof i))throw new Error("missing request parameter");t instanceof Array||(t=[t]);var e;for(e=0;e<t.length;e++)if(!1==t[e]instanceof i)throw new Error("invalid request parameter");for(e=0;e<t.length;e++)this.mocks.push(t[e]);this.mockPending||this.doMock()},a.prototype.start=function(r,i,n){if(!(r instanceof t))throw new Error("Application required");if(!(i instanceof e))throw new Error("presentation required");if("function"!=typeof n)throw new Error("callBack required");this.application=r,this.presentation=i,this.startCallback=n},a.prototype.stop=function(t){if("function"!=typeof t)throw new Error("callBack required")},a.prototype.dispatch=function(t,e){if(!1==t instanceof i)throw new Error("Request required");if(e&&"function"!=typeof e)throw new Error("response callback is not a function");this.application&&this.application.dispatch(t)||this.startCallback&&this.startCallback(t)},a.prototype.notify=function(t){if(!1==t instanceof i)throw new Error("Request required")},a.prototype.render=function(t,r){if(!1==t instanceof e)throw new Error("Presentation object required");if(r&&"function"!=typeof r)throw new Error("optional second argument must a commandRequest callback function")};var l=function(t){if(!1==this instanceof l)throw new Error("new operator required");if(!1==t instanceof c)throw new Error("argument required: model");this.model=t,this._items=[],this._itemIndex=-1};l.prototype.length=function(){return this._items.length},l.prototype.clear=function(){return this._items=[],this._itemIndex=-1,this},l.prototype.get=function(t){if(this._items.length<1)throw new Error("list is empty");for(var e=0;e<this.model.attributes.length;e++)if(this.model.attributes[e].name.toUpperCase()==t.toUpperCase())return this._items[this._itemIndex][e]},l.prototype.set=function(t,e){if(this._items.length<1)throw new Error("list is empty");for(var r=0;r<this.model.attributes.length;r++)if(this.model.attributes[r].name.toUpperCase()==t.toUpperCase())return void(this._items[this._itemIndex][r]=e);throw new Error("attribute not valid for list model")},l.prototype.addItem=function(t){var e,r=[];if(t)for(e in t.attributes)r.push(t.attributes[e].value);else for(e in this.model.attributes)r.push(void 0);return this._items.push(r),this._itemIndex=this._items.length-1,this},l.prototype.removeItem=function(){return this._items.splice(this._itemIndex,1),this._itemIndex--,this},l.prototype.indexedItem=function(t){return this._items.length<1?!1:0>t?!1:t>=this._items.length?!1:(this._itemIndex=t,!0)},l.prototype.moveNext=function(){return this._items.length<1?!1:this.indexedItem(this._itemIndex+1)},l.prototype.movePrevious=function(){return this._items.length<1?!1:this.indexedItem(this._itemIndex-1)},l.prototype.moveFirst=function(){return this._items.length<1?!1:this.indexedItem(0)},l.prototype.moveLast=function(){return this._items.length<1?!1:this.indexedItem(this._items.length-1)},l.prototype.sort=function(t){var e,r=0;for(var i in t)e||(e=i);if(!e)throw new Error("sort order required");for(var n=1==t[e];r<this.model.attributes.length&&this.model.attributes[r].name!=e;)r++;this._items.sort(function(t,e){if(n){if(t[r]<e[r])return-1;if(t[r]>e[r])return 1}else{if(t[r]>e[r])return-1;if(t[r]<e[r])return 1}return 0})};var c=function(t){var e;if(!1==this instanceof c)throw new Error("new operator required");if(this.modelType="Model",this.attributes=[new n("id","ID")],t=t||{},t.attributes)for(e in t.attributes)t.attributes.hasOwnProperty(e)&&this.attributes.push(t.attributes[e]);var r=getInvalidProperties(t,["attributes"]),i=this.getObjectStateErrors();for(e=0;e<r.length;e++)i.push("invalid property: "+r[e]);if(i.length>1)throw new Error("error creating Model: multiple errors");if(i.length)throw new Error("error creating Model: "+i[0]);this._eventListeners=[],this._errorConditions={}};c.prototype.toString=function(){return"a "+this.modelType},c.prototype.copy=function(t){for(var e=0;e<this.attributes.length;e++)this.attributes[e].value=t.attributes[e].value},c.prototype.getObjectStateErrors=function(){if(this.validationErrors=[],this.attributes instanceof Array)if(this.attributes.length<1)this.validationErrors.push("attributes must not be empty");else for(var t=0;t<this.attributes.length;t++)0!==t||this.attributes[t]instanceof n&&"ID"==this.attributes[t].type||this.validationErrors.push("first attribute must be ID"),this.attributes[t]instanceof n||this.validationErrors.push("attribute must be Attribute");else this.validationErrors.push("attributes must be Array");return void 0===this.tags||this.tags instanceof Array||this.validationErrors.push("tags must be Array or null"),this.validationErrors},c.prototype.get=function(t){for(var e=0;e<this.attributes.length;e++)if(this.attributes[e].name.toUpperCase()==t.toUpperCase())return this.attributes[e].value},c.prototype.getAttributeType=function(t){for(var e=0;e<this.attributes.length;e++)if(this.attributes[e].name.toUpperCase()==t.toUpperCase())return this.attributes[e].type},c.prototype.set=function(t,e){for(var r=0;r<this.attributes.length;r++)if(this.attributes[r].name.toUpperCase()==t.toUpperCase())return void(this.attributes[r].value=e);throw new Error("attribute not valid for model")},c.prototype.validate=function(t){var e,r,i=this,n=0;if("function"!=typeof t)throw new Error("callback is required");i.getObjectStateErrors();for(r in i._errorConditions)i._errorConditions.hasOwnProperty(r)&&i.validationErrors.push(i._errorConditions[r]);if(i.validationErrors.length)return i.validationMessage=i.validationErrors.length>0?i.validationErrors[0]:"",i._emitEvent("StateChange"),void t.call(i);for(e=0;e<i.attributes.length;e++)n++,function(e){setTimeout(function(){e.validate(function(){e.validationErrors.length&&i.validationErrors.push("bush"),0===--n&&(i.validationErrors.length||i._emitEvent("Validate"),i.validationMessage=i.validationErrors.length>0?i.validationErrors[0]:"",i._emitEvent("StateChange"),t.call(i))})},0)}(i.attributes[e])},c.prototype.onEvent=function(t,e){if(!(t instanceof Array)){if("string"!=typeof t)throw new Error("subscription string or array required");t=[t]}if("function"!=typeof e)throw new Error("callback is required");for(var r in t)if(t.hasOwnProperty(r)&&"*"!=t[r]&&!contains(["StateChange","Validate"],t[r]))throw new Error("Unknown command event: "+t[r]);return this._eventListeners.push({events:t,callback:e}),this},c.prototype._emitEvent=function(t){var e;for(e in this._eventListeners)if(this._eventListeners.hasOwnProperty(e)){var r=this._eventListeners[e];(r.events.length&&"*"===r.events[0]||contains(r.events,t))&&r.callback.call(this,t)}},c.prototype.setError=function(t,e){if(t=t||"",e=e||"",!t)throw new Error("condition required");if(!e)throw new Error("description required");this._errorConditions[t]=e},c.prototype.clearError=function(t){if(t=t||"",!t)throw new Error("condition required");delete this._errorConditions[t]},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=h),exports.CORE=h):u.CORE=h}).call(this);